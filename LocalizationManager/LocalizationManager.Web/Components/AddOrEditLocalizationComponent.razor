@using LocalizationManager.Transfer.LocalizationDtos
@using LocalizationManager.Web.Client

@inject ILocalizationClient LocalizationClient

<MudDialog>
    <DialogContent>
        <MudForm @ref="form">
            <MudGrid Spacing="2">
                <MudItem xs="6">
                    <MudTextField @bind-Value="_localizationValueDto.AppId" Label="App ID" Variant="Variant.Outlined" Required="true" />
                </MudItem>

                <MudItem xs="6">
                    <MudSelect @bind-Value="_localizationValueDto.LanguageCode" Label="Language" MultiSelection="false" Variant="Variant.Outlined" Required="true">
                        @foreach (var language in Languages)
                        {
                            <MudSelectItem Value="@language.LanguageCode">@language.LanguageName (@language.LanguageCode)</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="_localizationValueDto.Key" Label="Key" Variant="Variant.Outlined" Required="true" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudTextField @bind-Value="_localizationValueDto.Value" Label="Value"
                            Variant="Variant.Outlined" Required="true" Lines="3" MaxLength="500" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Secondary">Cancel</MudButton>

        <MudButton OnClick="SaveAsync" Color="Color.Primary">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;

    [Parameter] public LocalizationValueDto? LocalizationValue { get; set; } = null;

    private bool IsEdit = false;

    public List<LanguageDto> Languages { get; set; } = [ new LanguageDto { LanguageCode = "hu", LanguageName = "Hungarian" } ];

    private LocalizationValueDto _localizationValueDto = new();

    private MudForm form;

    protected override void OnParametersSet()
    {
        if (LocalizationValue != null)
        {
            _localizationValueDto = new LocalizationValueDto
            {
                AppId = LocalizationValue.AppId,
                Key = LocalizationValue.Key,
                LanguageCode = LocalizationValue.LanguageCode,
                Value = LocalizationValue.Value
            };

            IsEdit = true;
        }
    }

    private async Task SaveAsync()
    {
        await form.Validate();

        if (form.IsValid)
        {
            if (IsEdit)
            {
                await LocalizationClient.UpdateLocalizationValueAsync(_localizationValueDto);
            }
            else
            {
                await LocalizationClient.AddLocalizationValueAsync(_localizationValueDto);
            }

            MudDialog.Close(DialogResult.Ok(_localizationValueDto));
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}